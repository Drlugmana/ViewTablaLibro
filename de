namespace RestAPIDynatrace.Controllers              
{
    [Route("api/[controller]")]
    [ApiController]
    public class ProblemsController : ControllerBase
    {
        private readonly AppDbContext _context;

        public ProblemsController(AppDbContext context)
        {
            _context = context;
        }

        // GET: api/Problems
        [HttpGet]
        public async Task<ActionResult<PagedResponse<ProblemDynatraceResponse>>> GetProblems(int pageNumber = 1, int pageSize = 50)
        {
            var totalRecords = await _context.DynatraceProblems.CountAsync();
            var problems = await _context.DynatraceProblems
                                         .Skip((pageNumber - 1) * pageSize)
                                         .Take(pageSize)
                                         .ToListAsync();

            var deserializedProblems = problems.Select(problem =>
            {
                try
                {
                    return convertProblemJSON(problem);
                }
                catch (JsonException ex)
                {
                    return null;
                }
            }).Where(p => p != null).ToList();

            var response = new PagedResponse<ProblemDynatraceResponse>
            {
                TotalRecords = totalRecords,
                TotalPages = (int)Math.Ceiling(totalRecords / (double)pageSize),
                PageNumber = pageNumber,
                PageSize = pageSize,
                Data = deserializedProblems
            };

            return response;
        }


        [HttpGet("latest")]
        public async Task<ActionResult<PagedResponse<ProblemDynatraceResponse>>> GetProblemsLatest(
           [FromQuery] int pageNumber = 1,
           [FromQuery] int pageSize = 50,
           [FromQuery] string? jurisdiction = null
       )
        {
            // AYER 00:00 (hora del servidor)
            var startDate = DateTime.Today.AddDays(-1);

            // AHORA
            var endDate = DateTime.Now;

            // ⚠️ Si tu DBSet NO se llama _context.DynatraceProblems, cámbialo aquí:
            var baseQuery = _context.DynatraceProblems
                .AsNoTracking()
                .Where(p => p.StartTime >= startDate && p.StartTime <= endDate);

            if (!string.IsNullOrWhiteSpace(jurisdiction))
            {
                baseQuery = baseQuery.Where(p => p.Jurisdiction == jurisdiction);
            }

            // orden: más recientes primero
            baseQuery = baseQuery.OrderByDescending(p => p.StartTime);

            var totalRecords = await baseQuery.CountAsync();

            var problems = await baseQuery
                .Skip((pageNumber - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();

            // ✅ NO se pierden alertas por JSON inválido
            var deserializedProblems = new List<ProblemDynatraceResponse>(problems.Count);

            foreach (var problem in problems)
            {
                try
                {
                    var mapped = convertProblemJSON(problem);

                    // si tu convert devuelve null, igual la devolvemos mínimo
                    deserializedProblems.Add(mapped ?? BuildMinimalResponse(problem));
                }
                catch (JsonException)
                {
                    // ✅ no se pierde el registro
                    deserializedProblems.Add(BuildMinimalResponse(problem));
                }
                catch
                {
                    // por seguridad: cualquier otro error también devuelve mínimo
                    deserializedProblems.Add(BuildMinimalResponse(problem));
                }
            }

            var response = new PagedResponse<ProblemDynatraceResponse>
            {
                TotalRecords = totalRecords,
                TotalPages = (int)Math.Ceiling(totalRecords / (double)pageSize),
                PageNumber = pageNumber,
                PageSize = pageSize,
                Data = deserializedProblems
            };

            return response;
        }
