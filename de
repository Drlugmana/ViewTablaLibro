using Microsoft.EntityFrameworkCore;
using RestAPIDynatrace.Context;
using Microsoft.Extensions.Hosting.WindowsServices;

var builder = WebApplication.CreateBuilder(args);

// --- Ejecutar como servicio Windows (opcional, no afecta si corres .exe manual)
builder.Host.UseWindowsService();

// --- Kestrel (límites opcionales)
builder.WebHost.ConfigureKestrel(serverOptions =>
{
    serverOptions.Limits.MaxRequestBodySize = 104857600;              // 100 MB
    serverOptions.Limits.KeepAliveTimeout = TimeSpan.FromMinutes(10); // Keep-Alive
    serverOptions.Limits.RequestHeadersTimeout = TimeSpan.FromMinutes(10);
});

// --- CORS: PERMITE TU FRONT EN IIS Y TU FRONT LOCAL
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowFrontend", policy =>
    {
        policy
            .WithOrigins(
                "http://precwap021:8080",
                "http://PRECWAP021:8080",
                "http://10.70.144.250:8080",
                "http://localhost:5000"      // para desarrollo con Vite
            )
            .AllowAnyHeader()
            .AllowAnyMethod();
        // Si prefieres abierto mientras pruebas, usa .AllowAnyOrigin() y quita WithOrigins(...)
    });
});

// --- Servicios base
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// --- Base de datos
var cs = builder.Configuration.GetConnectionString("Connection");
builder.Services.AddDbContext<AppDbContext>(opt => opt.UseSqlServer(cs));

var app = builder.Build();

// --- Middleware
app.UseCors("AllowFrontend");

// Swagger SIEMPRE (también en Producción)
app.UseSwagger();
app.UseSwaggerUI(c =>
{
    // ✅ CLAVE 1: endpoint RELATIVO (evita problemas en IIS sub-aplicación)
    c.SwaggerEndpoint("v1/swagger.json", "RestAPIDynatraceReportes v1");

    // ✅ CLAVE 2: mejora compatibilidad (evita ciertos errores JS)
    c.ConfigObject.AdditionalItems["syntaxHighlight"] = false;

    c.RoutePrefix = "swagger"; // UI en /swagger
});

// NO fuerces HTTPS (tu API corre en http:5000)
//// app.UseHttpsRedirection();

app.UseAuthorization();
app.MapControllers();

// Healthcheck simple
app.MapGet("/", () => Results.Ok("✅ API RestAPIDynatraceReportes corriendo en el servidor"));

app.Run();